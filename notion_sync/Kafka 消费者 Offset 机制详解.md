# Kafka æ¶ˆè´¹è€… Offset æœºåˆ¶è¯¦è§£

_Last updated: 2025-02-28 08:22:59_

---

# **ğŸ“Œ å¼•è¨€**


åœ¨ä½¿ç”¨ Kafka è¿›è¡Œæ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼ŒOffset æœºåˆ¶æ˜¯ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚Offset å†³å®šäº†æ¶ˆè´¹è€…ä»å“ªé‡Œè¯»å–æ•°æ®ï¼Œå¹¶å½±å“æ¶ˆè´¹çš„å¯é æ€§ä¸ä¸€è‡´æ€§ã€‚æœ¬ç¯‡æ–‡ç« å°†æ·±å…¥å‰–æ Kafka Offset çš„å·¥ä½œåŸç†ï¼Œä»¥åŠ `auto.offset.reset` åœ¨ä¸åŒåœºæ™¯ä¸‹çš„è¡Œä¸ºã€‚


# **1. Kafka Offset æœºåˆ¶æ¦‚è¿°**


Kafka é‡‡ç”¨ Offsetï¼ˆåç§»é‡ï¼‰æ¥è·Ÿè¸ªæ¶ˆè´¹è€…çš„æ¶ˆè´¹è¿›åº¦ã€‚Offset æ˜¯æ¶ˆæ¯åœ¨ Kafka åˆ†åŒºä¸­çš„å”¯ä¸€ç¼–å·ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„è‡ªå¢ IDã€‚


- **Start Offset**ï¼ˆæ—¥å¿—èµ·å§‹ Offsetï¼‰ï¼šè¯¥åˆ†åŒºæœ€æ—©å¯ç”¨çš„æ¶ˆæ¯ Offsetï¼ˆå— Kafka æ—¥å¿—ä¿ç•™ç­–ç•¥å½±å“ï¼‰ã€‚

- **End Offset**ï¼ˆæ—¥å¿—ç»“æŸ Offsetï¼‰ï¼šè¯¥åˆ†åŒºæœ€æ–°æ¶ˆæ¯çš„ Offsetã€‚

- **Committed Offset**ï¼ˆå·²æäº¤ Offsetï¼‰ï¼šæ¶ˆè´¹è€…ç»„æäº¤çš„æœ€æ–° Offsetï¼Œè¡¨ç¤ºè¯¥æ¶ˆè´¹è€…å·²æˆåŠŸæ¶ˆè´¹çš„æ•°æ®ã€‚

- **Current Offset**ï¼ˆå½“å‰ Offsetï¼‰ï¼šæ¶ˆè´¹è€…**æ­£åœ¨æ¶ˆè´¹**çš„æ¶ˆæ¯ Offsetã€‚

Kafka å…è®¸æ¶ˆè´¹è€…æ‰‹åŠ¨æˆ–è‡ªåŠ¨æäº¤ Offsetï¼Œå¹¶æä¾› `auto.offset.reset` é€‰é¡¹æ¥å†³å®šåœ¨æ‰¾ä¸åˆ° Offset æ—¶çš„è¡Œä¸ºã€‚


# **2. **`**auto.offset.reset**`** è¯¦è§£**


# **ğŸ”¹ ä»€ä¹ˆæ˜¯ **`**auto.offset.reset**`**ï¼Ÿ**


`auto.offset.reset` å†³å®šäº†æ¶ˆè´¹è€…åœ¨ Kafka **æ‰¾ä¸åˆ°å·²æäº¤çš„ Offset** æ—¶åº”è¯¥å¦‚ä½•å¤„ç†ã€‚


- `earliest`ï¼šä» **Start Offset**ï¼ˆæœ€æ—©å¯ç”¨æ¶ˆæ¯ï¼‰å¼€å§‹æ¶ˆè´¹ã€‚

- `latest`ï¼šä» **End Offset**ï¼ˆæœ€æ–°å†™å…¥çš„æ¶ˆæ¯ï¼‰å¼€å§‹æ¶ˆè´¹ã€‚

- `none`ï¼šå¦‚æœæ‰¾ä¸åˆ° Offsetï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

# **ğŸ”¹ ä»€ä¹ˆæ—¶å€™ Kafka ä¼šâ€œæ‰¾ä¸åˆ° Offsetâ€ï¼Ÿ**


Kafka æ‰¾ä¸åˆ° Offset ä¸»è¦å‘ç”Ÿåœ¨ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š


| åœºæ™¯ | å‘ç”ŸåŸå›  | å½±å“ |
| --- | --- | --- |
| **æ–°æ¶ˆè´¹è€…ç»„** | `group.id` ä»æœªæ¶ˆè´¹è¿‡è¯¥ä¸»é¢˜ï¼Œæ²¡æœ‰ Offset è®°å½• | æŒ‰ `auto.offset.reset` è§„åˆ™æ¶ˆè´¹ |
| **Offset è¿‡æœŸ** | è¶…è¿‡ `offsets.retention.minutes`ï¼ˆé»˜è®¤ 7 å¤©ï¼‰ï¼ŒKafka è‡ªåŠ¨æ¸…ç† Offset | æŒ‰ `auto.offset.reset` è§„åˆ™æ¶ˆè´¹ |
| **ä¸»é¢˜è¢«åˆ é™¤/é‡å»º** | ä¸»é¢˜è¢«åˆ é™¤åé‡æ–°åˆ›å»ºï¼ŒåŸ Offset è®°å½•ä¸¢å¤± | æŒ‰ `auto.offset.reset` è§„åˆ™æ¶ˆè´¹ |
| **åˆ†åŒºè°ƒæ•´** | Kafka é‡æ–°åˆ†é…åˆ†åŒºï¼Œå¯¼è‡´ Offset å¤±æ•ˆ | æŒ‰ `auto.offset.reset` è§„åˆ™æ¶ˆè´¹ |


# **3. **`**enable.auto.commit=false**`** æ—¶ï¼ŒOffset ä½•æ—¶æ›´æ–°ï¼Ÿ**


å½“ `enable.auto.commit=false` æ—¶ï¼ŒKafka **ä¸ä¼šè‡ªåŠ¨æäº¤ Offset**ï¼Œæ¶ˆè´¹è€…éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `consumer.commit()` è¿›è¡Œæäº¤ã€‚


**å¦‚æœä¸æ‰‹åŠ¨ **`**commit()**`**ï¼ŒOffset ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**


- **Kafka ä¸ä¼šæ›´æ–° Offset**ï¼Œä¸‹æ¬¡é‡å¯æ¶ˆè´¹è€…æ—¶ä¼šä»æ—§çš„ Offset é‡æ–°æ¶ˆè´¹ï¼ˆå¯èƒ½ä¼šé‡å¤æ¶ˆè´¹ï¼‰ã€‚

- **Offset åªä¼šåœ¨ **`**commit()**`** ä¹‹åæ›´æ–°**ï¼Œå¦åˆ™ Kafka è®¤ä¸ºè¿™æ¡æ¶ˆæ¯è¿˜æœªæ¶ˆè´¹å®Œæˆã€‚

**ç¤ºä¾‹ä»£ç ï¼š**


```python
from confluent_kafka import Consumer

consumer = Consumer({
    'bootstrap.servers': 'localhost:9092',
    'group.id': 'my-group',
    'auto.offset.reset': 'earliest',
    'enable.auto.commit': False
})

consumer.subscribe(['my-topic'])

while True:
    msg = consumer.poll(1.0)
    if msg is None:
        continue
    print(f"Received message: {msg.value().decode('utf-8')}")
    consumer.commit()  # æ‰‹åŠ¨æäº¤ Offset

```


# **4. **`**max.poll.interval.ms**`** å’Œæ¶ˆè´¹è€…ä¼šè¯ç®¡ç†**


Kafka é€šè¿‡ `max.poll.interval.ms` æ§åˆ¶æ¶ˆè´¹è€…çš„æ´»è·ƒæ€§ã€‚


# **ğŸ”¹ **`**max.poll.interval.ms**`** æœºåˆ¶**


- **ä½œç”¨**ï¼šå¦‚æœ `poll()` è°ƒç”¨é—´éš”è¶…è¿‡ `max.poll.interval.ms`ï¼ŒKafka è®¤ä¸ºè¯¥æ¶ˆè´¹è€…å·²å¤±æ•ˆï¼Œä¼šè§¦å‘ Rebalanceã€‚

- **é»˜è®¤å€¼**ï¼š`300000ms`ï¼ˆ5åˆ†é’Ÿï¼‰ã€‚

- **å½±å“**ï¼šå¦‚æœæ¶ˆè´¹é€»è¾‘å¤ªæ…¢ï¼Œæˆ–è€… `poll()` è¿Ÿè¿Ÿæœªè¢«è°ƒç”¨ï¼Œæ¶ˆè´¹è€…ä¼šè¢«è¸¢å‡ºæ¶ˆè´¹ç»„ï¼Œå¯¼è‡´åˆ†åŒºé‡æ–°åˆ†é…ã€‚

# **ğŸ”¹ **`**session.timeout.ms**`** æœºåˆ¶**


- **ä½œç”¨**ï¼šå¦‚æœæ¶ˆè´¹è€…åœ¨ `session.timeout.ms` å†…æ²¡æœ‰å‘ Kafka å‘é€å¿ƒè·³ï¼ŒKafka è®¤ä¸ºå®ƒå·²å¤±è”ï¼Œè§¦å‘ Rebalanceã€‚

- **é»˜è®¤å€¼**ï¼š`45000ms`ï¼ˆ45ç§’ï¼‰ã€‚

- **å½±å“**ï¼šå¦‚æœæ¶ˆè´¹è€…è¿›ç¨‹å´©æºƒæˆ–ç½‘ç»œé—®é¢˜ï¼ŒKafka ä¼šå¿«é€Ÿ Rebalanceã€‚

**ç¤ºä¾‹ä»£ç ï¼šé¿å…å›  **`**poll()**`** è¿‡æ…¢è¢«è¸¢å‡ºæ¶ˆè´¹ç»„**


```python
consumer = Consumer({
    'bootstrap.servers': 'localhost:9092',
    'group.id': 'my-group',
    'auto.offset.reset': 'earliest',
    'enable.auto.commit': False,
    'max.poll.interval.ms': 600000  # 10åˆ†é’Ÿ
})

while True:
    msg = consumer.poll(1.0)
    if msg is None:
        continue  # å³ä½¿æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œä¹Ÿè¦ç»§ç»­ poll()ï¼Œå¦åˆ™å¯èƒ½è¢«è¸¢å‡º
    print(f"Received: {msg.value().decode('utf-8')}")
    consumer.commit()

```


# **5. é¿å… Kafka Offset ä¸¢å¤±çš„æœ€ä½³å®è·µ**


ä¸ºäº†ä¿è¯ Kafka Offset ä¸ä¼šä¸¢å¤±ï¼Œé¿å… `auto.offset.reset` è§¦å‘æ„å¤–è¡Œä¸ºï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š


# **âœ… å®šæœŸæäº¤ Offset**


- å…³é—­ `enable.auto.commit`ï¼Œå¹¶æ‰‹åŠ¨ `commit()`ã€‚

- ä¾‹å¦‚ï¼Œæ¯ 100 æ¡æ¶ˆæ¯æäº¤ä¸€æ¬¡ Offsetã€‚

# **âœ… é¿å…é•¿æ—¶é—´ä¸æ¶ˆè´¹**


- å®šæœŸå¯åŠ¨æ¶ˆè´¹è€…ï¼Œé¿å…è¶…è¿‡ `offsets.retention.minutes`ï¼ˆé»˜è®¤ 7 å¤©ï¼‰ã€‚

# **âœ… ä½¿ç”¨ **`**kafka-consumer-groups.sh**`** ç›‘æ§ Offset**


```plain text
kafka-consumer-groups.sh --bootstrap-server localhost:9092 --group my-group --describe

```


# **âœ… è®¾ç½®åˆç†çš„ **`**max.poll.interval.ms**`** å’Œ **`**session.timeout.ms**`


- ç¡®ä¿æ¶ˆè´¹è€…ä¸ä¼šå› æ¶ˆè´¹å¤ªæ…¢è¢«è¸¢å‡ºæ¶ˆè´¹ç»„ã€‚

# **ğŸ“Œ æ€»ç»“**


- **Kafka åªæœ‰åœ¨æ‰¾ä¸åˆ° Offset æ—¶ï¼Œæ‰ä¼šæ ¹æ® **`**auto.offset.reset**`** è§„åˆ™å†³å®šä»å“ªé‡Œæ¶ˆè´¹ã€‚**

- `**enable.auto.commit=false**`** æ—¶ï¼ŒOffset éœ€è¦æ‰‹åŠ¨ **`**commit()**`**ï¼Œå¦åˆ™ä¸ä¼šå‰è¿›ã€‚**

- `**max.poll.interval.ms**`** å½±å“æ¶ˆè´¹è€…çš„å­˜æ´»ï¼Œè¿‡é•¿çš„å¤„ç†æ—¶é—´å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…è¢«è¸¢å‡ºæ¶ˆè´¹ç»„ã€‚**

- **é¿å… Offset ä¸¢å¤±çš„æ–¹æ³•åŒ…æ‹¬ï¼šå®šæœŸæäº¤ Offsetã€é¿å…é•¿æ—¶é—´ä¸æ¶ˆè´¹ã€ç›‘æ§ Offset å˜åŒ–ã€‚**

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ Kafka Offset æœºåˆ¶ï¼å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿äº¤æµï¼ ğŸš€


# **Kafka æ¶ˆè´¹è€… Offset æœºåˆ¶è¯¦è§£ï¼šä»å…¥é—¨åˆ°è¿›é˜¶**


# **ğŸ“Œ å¼•è¨€**


åœ¨ä½¿ç”¨ Kafka è¿›è¡Œæ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼ŒOffset æœºåˆ¶æ˜¯ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚Offset å†³å®šäº†æ¶ˆè´¹è€…ä»å“ªé‡Œè¯»å–æ•°æ®ï¼Œå¹¶å½±å“æ¶ˆè´¹çš„å¯é æ€§ä¸ä¸€è‡´æ€§ã€‚æœ¬ç¯‡æ–‡ç« å°†æ·±å…¥å‰–æ Kafka Offset çš„å·¥ä½œåŸç†ï¼Œä»¥åŠ `auto.offset.reset` åœ¨ä¸åŒåœºæ™¯ä¸‹çš„è¡Œä¸ºã€‚


# **1. Kafka Offset æœºåˆ¶æ¦‚è¿°**


Kafka é‡‡ç”¨ Offsetï¼ˆåç§»é‡ï¼‰æ¥è·Ÿè¸ªæ¶ˆè´¹è€…çš„æ¶ˆè´¹è¿›åº¦ã€‚Offset æ˜¯æ¶ˆæ¯åœ¨ Kafka åˆ†åŒºä¸­çš„å”¯ä¸€ç¼–å·ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„è‡ªå¢ IDã€‚


- **Start Offset**ï¼ˆæ—¥å¿—èµ·å§‹ Offsetï¼‰ï¼šè¯¥åˆ†åŒºæœ€æ—©å¯ç”¨çš„æ¶ˆæ¯ Offsetï¼ˆå— Kafka æ—¥å¿—ä¿ç•™ç­–ç•¥å½±å“ï¼‰ã€‚

- **End Offset**ï¼ˆæ—¥å¿—ç»“æŸ Offsetï¼‰ï¼šè¯¥åˆ†åŒºæœ€æ–°æ¶ˆæ¯çš„ Offsetã€‚

- **Committed Offset**ï¼ˆå·²æäº¤ Offsetï¼‰ï¼šæ¶ˆè´¹è€…ç»„æäº¤çš„æœ€æ–° Offsetï¼Œè¡¨ç¤ºè¯¥æ¶ˆè´¹è€…å·²æˆåŠŸæ¶ˆè´¹çš„æ•°æ®ã€‚

- **Current Offset**ï¼ˆå½“å‰ Offsetï¼‰ï¼šæ¶ˆè´¹è€…**æ­£åœ¨æ¶ˆè´¹**çš„æ¶ˆæ¯ Offsetã€‚

Kafka å…è®¸æ¶ˆè´¹è€…æ‰‹åŠ¨æˆ–è‡ªåŠ¨æäº¤ Offsetï¼Œå¹¶æä¾› `auto.offset.reset` é€‰é¡¹æ¥å†³å®šåœ¨æ‰¾ä¸åˆ° Offset æ—¶çš„è¡Œä¸ºã€‚


# **2. **`**auto.offset.reset**`** è¯¦è§£**


# **ğŸ”¹ ä»€ä¹ˆæ˜¯ **`**auto.offset.reset**`**ï¼Ÿ**


`auto.offset.reset` å†³å®šäº†æ¶ˆè´¹è€…åœ¨ Kafka **æ‰¾ä¸åˆ°å·²æäº¤çš„ Offset** æ—¶åº”è¯¥å¦‚ä½•å¤„ç†ã€‚


- `earliest`ï¼šä» **Start Offset**ï¼ˆæœ€æ—©å¯ç”¨æ¶ˆæ¯ï¼‰å¼€å§‹æ¶ˆè´¹ã€‚

- `latest`ï¼šä» **End Offset**ï¼ˆæœ€æ–°å†™å…¥çš„æ¶ˆæ¯ï¼‰å¼€å§‹æ¶ˆè´¹ã€‚

- `none`ï¼šå¦‚æœæ‰¾ä¸åˆ° Offsetï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

# **ğŸ”¹ ä»€ä¹ˆæ—¶å€™ Kafka ä¼šâ€œæ‰¾ä¸åˆ° Offsetâ€ï¼Ÿ**


Kafka æ‰¾ä¸åˆ° Offset ä¸»è¦å‘ç”Ÿåœ¨ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š


| åœºæ™¯ | å‘ç”ŸåŸå›  | å½±å“ |
| --- | --- | --- |
| **æ–°æ¶ˆè´¹è€…ç»„** | `group.id` ä»æœªæ¶ˆè´¹è¿‡è¯¥ä¸»é¢˜ï¼Œæ²¡æœ‰ Offset è®°å½• | æŒ‰ `auto.offset.reset` è§„åˆ™æ¶ˆè´¹ |
| **Offset è¿‡æœŸ** | è¶…è¿‡ `offsets.retention.minutes`ï¼ˆé»˜è®¤ 7 å¤©ï¼‰ï¼ŒKafka è‡ªåŠ¨æ¸…ç† Offset | æŒ‰ `auto.offset.reset` è§„åˆ™æ¶ˆè´¹ |
| **ä¸»é¢˜è¢«åˆ é™¤/é‡å»º** | ä¸»é¢˜è¢«åˆ é™¤åé‡æ–°åˆ›å»ºï¼ŒåŸ Offset è®°å½•ä¸¢å¤± | æŒ‰ `auto.offset.reset` è§„åˆ™æ¶ˆè´¹ |
| **åˆ†åŒºè°ƒæ•´** | Kafka é‡æ–°åˆ†é…åˆ†åŒºï¼Œå¯¼è‡´ Offset å¤±æ•ˆ | æŒ‰ `auto.offset.reset` è§„åˆ™æ¶ˆè´¹ |


# **3. **`**enable.auto.commit=false**`** æ—¶ï¼ŒOffset ä½•æ—¶æ›´æ–°ï¼Ÿ**


å½“ `enable.auto.commit=false` æ—¶ï¼ŒKafka **ä¸ä¼šè‡ªåŠ¨æäº¤ Offset**ï¼Œæ¶ˆè´¹è€…éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `consumer.commit()` è¿›è¡Œæäº¤ã€‚


**å¦‚æœä¸æ‰‹åŠ¨ **`**commit()**`**ï¼ŒOffset ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**


- **Kafka ä¸ä¼šæ›´æ–° Offset**ï¼Œä¸‹æ¬¡é‡å¯æ¶ˆè´¹è€…æ—¶ä¼šä»æ—§çš„ Offset é‡æ–°æ¶ˆè´¹ï¼ˆå¯èƒ½ä¼šé‡å¤æ¶ˆè´¹ï¼‰ã€‚

- **Offset åªä¼šåœ¨ **`**commit()**`** ä¹‹åæ›´æ–°**ï¼Œå¦åˆ™ Kafka è®¤ä¸ºè¿™æ¡æ¶ˆæ¯è¿˜æœªæ¶ˆè´¹å®Œæˆã€‚

**ç¤ºä¾‹ä»£ç ï¼š**


```python
from confluent_kafka import Consumer

consumer = Consumer({
    'bootstrap.servers': 'localhost:9092',
    'group.id': 'my-group',
    'auto.offset.reset': 'earliest',
    'enable.auto.commit': False
})

consumer.subscribe(['my-topic'])

while True:
    msg = consumer.poll(1.0)
    if msg is None:
        continue
    print(f"Received message: {msg.value().decode('utf-8')}")
    consumer.commit()  # æ‰‹åŠ¨æäº¤ Offset

```


# **4. **`**max.poll.interval.ms**`** å’Œæ¶ˆè´¹è€…ä¼šè¯ç®¡ç†**


Kafka é€šè¿‡ `max.poll.interval.ms` æ§åˆ¶æ¶ˆè´¹è€…çš„æ´»è·ƒæ€§ã€‚


# **ğŸ”¹ **`**max.poll.interval.ms**`** æœºåˆ¶**


- **ä½œç”¨**ï¼šå¦‚æœ `poll()` è°ƒç”¨é—´éš”è¶…è¿‡ `max.poll.interval.ms`ï¼ŒKafka è®¤ä¸ºè¯¥æ¶ˆè´¹è€…å·²å¤±æ•ˆï¼Œä¼šè§¦å‘ Rebalanceã€‚

- **é»˜è®¤å€¼**ï¼š`300000ms`ï¼ˆ5åˆ†é’Ÿï¼‰ã€‚

- **å½±å“**ï¼šå¦‚æœæ¶ˆè´¹é€»è¾‘å¤ªæ…¢ï¼Œæˆ–è€… `poll()` è¿Ÿè¿Ÿæœªè¢«è°ƒç”¨ï¼Œæ¶ˆè´¹è€…ä¼šè¢«è¸¢å‡ºæ¶ˆè´¹ç»„ï¼Œå¯¼è‡´åˆ†åŒºé‡æ–°åˆ†é…ã€‚

# **ğŸ”¹ **`**session.timeout.ms**`** æœºåˆ¶**


- **ä½œç”¨**ï¼šå¦‚æœæ¶ˆè´¹è€…åœ¨ `session.timeout.ms` å†…æ²¡æœ‰å‘ Kafka å‘é€å¿ƒè·³ï¼ŒKafka è®¤ä¸ºå®ƒå·²å¤±è”ï¼Œè§¦å‘ Rebalanceã€‚

- **é»˜è®¤å€¼**ï¼š`45000ms`ï¼ˆ45ç§’ï¼‰ã€‚

- **å½±å“**ï¼šå¦‚æœæ¶ˆè´¹è€…è¿›ç¨‹å´©æºƒæˆ–ç½‘ç»œé—®é¢˜ï¼ŒKafka ä¼šå¿«é€Ÿ Rebalanceã€‚
